version: '3.8' # 도커 컴포즈 버전

services:
  # 1. 데이터베이스 (PostgreSQL + pgvector)
  db:
    image: ankane/pgvector:v0.5.1 # pgvector가 포함된 이미지 사용
    container_name: movie_db
    environment:
      - POSTGRES_USER=admin
      - POSTGRES_PASSWORD=admin
      - POSTGRES_DB=movie_db
    volumes:
      - postgres_data:/var/lib/postgresql/data # 데이터 영속성 유지
    ports:
      - "8888:5432" # DB 포트 (호스트 PC에서 DB Tool로 접속 가능)

  # 2. 백엔드 (FastAPI)
  api:
    container_name: movie_api
    build: ./backend # ./backend 폴더의 Dockerfile을 빌드
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --reload
    volumes:
      - ./backend:/app # 호스트의 ./backend 폴더를 컨테이너 /app에 마운트
    ports:
      - "8000:8000" # API 서버 포트
    depends_on:
      - db          # DB가 실행된 후에 API 서버가 실행되도록 설정
    environment:
      - DATABASE_URL=postgresql://admin:admin@db:5432/movie_db
    env_file: 
      - ./.env

  # 3. 프론트엔드 (React)
  web:
    container_name: movie_web
    build: ./frontend # ./frontend 폴더의 Dockerfile을 빌드
    volumes:
      - ./frontend:/app # 코드 변경 시 자동 반영 (Hot Reloading)
      - /app/node_modules # node_modules는 마운트에서 제외
    ports:
      - "5173:5173" # React 개발 서버 포트
    depends_on:
      - api         # API 서버가 실행된 후에 웹이 실행되도록 설정
    stdin_open: true  # React 개발 서버를 위한 설정
    tty: true         # React 개발 서버를 위한 설정

volumes:
  postgres_data: # DB 데이터를 저장할 볼륨 정의